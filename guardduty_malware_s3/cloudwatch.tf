resource "aws_cloudwatch_metric_alarm" "malware_completed_scan_count" {
  count = var.alarms_enabled ? 1 : 0

  alarm_name          = "MalwareS3-ScanCount-${var.s3_bucket_name}"
  alarm_description   = "Scanned more than ${var.alarm_completed_scan_count_threshold} objects in 1 day."
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "CompletedScanCount"
  namespace           = "AWS/GuardDuty/MalwareProtection"
  period              = 86400
  statistic           = "Sum"
  threshold           = var.alarm_completed_scan_count_threshold
  treat_missing_data  = "notBreaching"

  dimensions = {
    "Resource Name"              = var.s3_bucket_name
    "Malware Protection Plan Id" = aws_guardduty_malware_protection_plan.this.id
  }

  alarm_actions = var.alarm_sns_topic_alarm_arn != null ? [var.alarm_sns_topic_alarm_arn] : []
  ok_actions    = var.alarm_sns_topic_ok_arn != null ? [var.alarm_sns_topic_ok_arn] : []
}

resource "aws_cloudwatch_metric_alarm" "malware_completed_scan_bytes" {
  count = var.alarms_enabled ? 1 : 0

  alarm_name          = "MalwareS3-ScanBytes-${var.s3_bucket_name}"
  alarm_description   = "Scanned more than ${var.alarm_completed_scan_gigabytes_threshold} GB in 1 day."
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "CompletedScanBytes"
  namespace           = "AWS/GuardDuty/MalwareProtection"
  period              = 86400
  statistic           = "Sum"
  threshold           = var.alarm_completed_scan_gigabytes_threshold * 1024 * 1024 * 1024 # Convert GB to bytes
  treat_missing_data  = "notBreaching"

  dimensions = {
    "Resource Name"              = var.s3_bucket_name
    "Malware Protection Plan Id" = aws_guardduty_malware_protection_plan.this.id
  }

  alarm_actions = var.alarm_sns_topic_alarm_arn != null ? [var.alarm_sns_topic_alarm_arn] : []
  ok_actions    = var.alarm_sns_topic_ok_arn != null ? [var.alarm_sns_topic_ok_arn] : []
}
